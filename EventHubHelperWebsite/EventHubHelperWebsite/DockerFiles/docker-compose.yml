version: "3.8"

services:
  # --- Event Hubs Emulator ---
  emulator:
    container_name: eventhubs-emulator
    image: mcr.microsoft.com/azure-messaging/eventhubs-emulator:latest
    volumes:
      - "${CONFIG_PATH}:/Eventhubs_Emulator/ConfigFiles/Config.json:ro"
    ports:
      - "5672:5672"
      - "9092:9092"
    environment:
      BLOB_SERVER: azurite
      METADATA_SERVER: azurite
      ACCEPT_EULA: ${ACCEPT_EULA}
    depends_on:
      - azurite
      - cosmos-emulator # Added dependency
    networks:
      eh-emulator:
        aliases:
          - eventhubs-emulator

  # --- Azurite ---
  azurite:
    container_name: azurite
    image: mcr.microsoft.com/azure-storage/azurite:latest
    ports:
      - "10000:10000"
      - "10001:10001"
      - "10002:10002"
    networks:
      eh-emulator:
        aliases:
          - azurite

  # --- Cosmos DB Emulator (Final Corrected Version) ---
  cosmos-emulator:
    container_name: cosmos-emulator
    image: mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:vnext-preview
    # FIX: Explicitly tell the container to use HTTPS for the gateway and explorer
    command: ["--protocol", "https", "--explorer-protocol", "https"]
    ports:
      - "8081:8081"
      - "1234:1234"
    environment:
      - AZURE_COSMOS_EMULATOR_PARTITION_COUNT=10
      - AZURE_COSMOS_EMULATOR_ENABLE_DATA_EXPLORER=true
      - AZURE_COSMOS_EMULATOR_IP_ADDRESS_OVERRIDE=127.0.0.1
      - AZURE_COSMOS_EMULATOR_ALLOWED_ORIGINS=https://localhost:8081,https://localhost:1234
    volumes:
      - cosmos_data:/var/lib/cosmosdb
    deploy:
      resources:
        limits:
          memory: 4G

networks:
  eh-emulator:
    driver: bridge

volumes:
  cosmos_data: